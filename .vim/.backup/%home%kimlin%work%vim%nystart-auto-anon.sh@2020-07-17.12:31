#!/bin/bash
#NOTES
#Project nystart successfully restarted, version: v4.11.3-build.1, environment: nystart-staging2:STAGING
#Snapshot nystart-prod-backup-20200712000001_v4.11.3-build.1 loaded successfully !
#db.getCollection('JobLog').find({})
# set pipefail to pass fail throuh pipe
set -o pipefail
# Some nice logs
function LOG { $* |& while read out; 
    do echo "$(date '+[%y/%m/%d %H:%M:%S]')" "$out"
done |& tee }

LOG bash /data/lfp/lfp-tools.sh load -f nystart-prod-backup-20200712000001_v4.11.3-build.1
LOG echo "Lets get NYSTARTED. Load Status = $?"

LOG echo "bash /data/lfp/lfp-tools.sh start nystart"
LOG echo "Time to start looping mongo. Start Status = $?"
sleep 10
while true; do 
LOG mongo 127.0.0.1:27027/Operation -u MongoAdmin -p l34nd3vMongo4dm1n \
--authenticationDatabase "admin" --verbose \
--eval 'db.JobDefinitionEntity.update({}, {$set: {"enabled" : false}},  {multi: true});' \
&& break \
|| LOG echo "No contact, sleeping 5 sec" && sleep 5 
done

backup_name=$(echo nystart-Anon-backup-20200713220001_nystart-stage2_$(/bin/date +\%Y\%m\%dT\%H\%M\%S)_$(/usr/bin/git describe --tags))
LOG echo "Backup_name is $backup_name"
LOG bash /data/lfp/lfp-tools.sh save-unidentify $backup_name
LOG echo "Time to stop nystart. save-unidentify exit=$?"
bash /data/lfp/lfp-tools.sh stop
LOG echo "Finished. stop status = $?"

# restore pipefail
set +o pipefail
