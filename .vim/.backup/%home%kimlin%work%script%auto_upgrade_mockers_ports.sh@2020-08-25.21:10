# set pipefail to pass fail throuh pipe
set -o pipefail
# Some nice logs 
function LOG { 
$* |& while read out; do 
          echo "$(date '+[%y/%m/%d %H:%M:%S]')" "$out"
      done |& tee
}

# Change directory for relative paths in lfp script
cd /data/lfp

# Load the backup
LOG bash /data/lfp/lfp-tools.sh load -f nystart-prod-backup-20200825000001_v4.11.3-build.1
LOG echo "Lets get NYSTARTED. Load Status = $?"

LOG echo "Press Enter to save start nystart or exit script with ^C" && read -p "Enter / ^C: "

# Start nystart to access mongo and disble jobs
LOG bash /data/lfp/lfp-tools.sh start nystart
LOG echo "Time to start looping mongo. Start Status = $?"
sleep 10
while true; do 
    LOG mongo 127.0.0.1:27027/Operation -u MongoAdmin -p l34nd3vMongo4dm1n \
    --authenticationDatabase "admin" --verbose \
    --eval 'db.JobDefinitionEntity.update({}, {$set: {"enabled" : false}},  {multi: true});' && \ 
    break || \
    echo "No contact, sleeping 5 sec" && \ 
    sleep 5 
done

# Save anon db if mongo was succesfull
LOG echo "Press Enter to save anon backup or exit script with ^C" && read -p "Enter / ^C: "
backup_name=$(echo nystart-Anon-backup_$(/bin/date +\%Y\%m\%dT\%H\%M\%S)_$(/usr/bin/git describe --tags))
LOG echo "Backup_name is $backup_name"
LOG bash /data/lfp/lfp-tools.sh save-unidentify "$backup_name"
LOG echo "Time to stop nystart. save-unidentify exit=$?"

# Stop lfp
LOG echo "Press Enter to stop or exit script with ^C" && read -p "Enter / ^C: "
bash /data/lfp/lfp-tools.sh stop
LOG echo "Finished. stop status = $?"

# Check backup folder to see if we have backup then load backup
LOG ls -lh /data/lfp/snapshots/nystart-Anon*
LOG echo "Press Enter to load backup or exit script with ^C" && read -p "Enter / ^C: "
bash /data/lfp/lfp-tools.sh load -f "$backup_name"

# restore pipefail
set +o pipefail
